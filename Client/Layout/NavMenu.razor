
@using QND.Core.Models
@inject HttpClient Http
@inject NavigationManager NavManager

<PageTitle>Thực Đơn - Bàn @TableCode</PageTitle>

<div class="container mobile-first-design">
    <h3 class="mb-4 text-center">🍻 Thực Đơn Quán Nhậu (Bàn: @TableCode)</h3>

    @if (MenuItems == null)
    {
        <p><em>Đang tải thực đơn...</em></p>
    }
    else
    {
        <div class="row">
            @foreach (var item in MenuItems)
            {
                <div class="col-12 col-md-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">@item.Name</h5>
                            <p class="card-text text-danger fw-bold">@item.Price.ToString("N0") VNĐ</p>
                            <p class="card-text small text-muted">@item.Description</p>

                            <button class="btn btn-sm btn-success" @onclick="() => AddToCart(item)">
                                <span class="oi oi-plus"></span> Thêm vào Giỏ
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="fixed-bottom p-3 bg-dark text-white shadow-lg">
            Giỏ hàng: **@CartItems.Count** món | Tổng tiền: **@TotalAmount.ToString("N0") VNĐ**
            <button class="btn btn-warning float-end" @onclick="Checkout">Xem Giỏ hàng</button>
        </div>
    }
</div>


@code {
    [Parameter]
    public string TableCode { get; set; } = string.Empty; // Nhận mã bàn từ URL

    private List<MenuItem>? MenuItems;
    private List<QND.Core.Models.MenuItem> CartItems = new List<QND.Core.Models.MenuItem>();
    private decimal TotalAmount => CartItems.Sum(i => i.Price);

    // Khai báo API URL
    private string ApiBaseUrl = "https://localhost:7001";

    protected override async Task OnInitializedAsync()
    {
        // 1. Kết nối SignalR (sử dụng dịch vụ đã tạo)
        // Cần inject SignalRService và gọi StartConnection(TableCode)

        // 2. Tải Menu từ API
        try
        {
            // Tạm thời tạo MenuItems giả lập vì API chưa có endpoint
            MenuItems = new List<MenuItem>
            {
                new QND.Core.Models.MenuItem { Id = 1, Name = "Bò Tái Chanh", Price = 150000, Description = "Bò tươi trộn chanh và rau thơm." },
                new QND.Core.Models.MenuItem { Id = 2, Name = "Lẩu Thái Hải Sản", Price = 250000, Description = "Cay chua, nhiều hải sản tươi." },
                new QND.Core.Models.MenuItem { Id = 3, Name = "Bia Hà Nội (Chai)", Price = 20000, Description = "Bia truyền thống, mát lạnh." }
            };

            // Code thực tế khi API sẵn sàng:
            // MenuItems = await Http.GetFromJsonAsync<List<QND.Core.Models.MenuItem>>($"{ApiBaseUrl}/api/menu");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Lỗi tải menu: {ex.Message}");
            // Xử lý lỗi
        }
    }

    private void AddToCart(QND.Core.Models.MenuItem item)
    {
        CartItems.Add(item);
        // Sau này, bạn sẽ cần nhóm các món trùng nhau và chỉ tăng Quantity
    }

    private void Checkout()
    {
        // Điều hướng sang trang Giỏ hàng hoặc gọi phương thức PlaceOrder
        Console.WriteLine("Tiến hành kiểm tra giỏ hàng...");
        // NavManager.NavigateTo($"/cart/{TableCode}");
    }
}