@page "/menu/{tableCode}"
@inject NavigationManager NavManager

<PageTitle>Thực Đơn - Bàn @TableCode</PageTitle>

<div class="container mobile-first-design pb-6 mb-6" style="padding-bottom: 100px;">

    <h4 class="text-center fw-bold mb-3">🍻 Thực Đơn Quán Nhậu (Bàn: @TableCode)</h4>

    @if (MenuItems == null)
    {
        <p class="text-center"><em>Đang tải thực đơn...</em></p>
    }
    else
    {
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
            @foreach (var item in MenuItems)
            {
                <div class="col">
                    <Client.Components.MenuCard Item="item" AddToCart="OnAddToCart" />
                </div>
            }
        </div>


        <!-- Thanh cố định cuối màn hình -->
        <div class="cart-bar fixed-bottom bg-dark text-white shadow-lg p-2 px-3">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2">
                <div class="text-center text-sm-start">
                    <small>Giỏ hàng: <b>@CartItems.Count</b> món</small> <br />
                    <small>Tổng tiền (tạm tính): <b>@TotalAmount.ToString("N0") VNĐ</b></small>
                </div>
                <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-sm-auto">
                    <button class="btn btn-warning fw-bold w-100 w-sm-auto" @onclick="Checkout">
                        🍽️ Xem món đã gọi
                    </button>
                    <button class="btn btn-success fw-bold w-100 w-sm-auto" @onclick="PayNow">
                        💰 Gọi nhân viên thanh toán (@TotalAmount.ToString("N0") VNĐ)
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string TableCode { get; set; } = string.Empty;

    private List<QND.Core.Models.MenuItem>? MenuItems;
    private List<(QND.Core.Models.MenuItem Item, int Quantity)> CartItems = new();

    private decimal TotalAmount => CartItems.Sum(i => i.Item.Price * i.Quantity);

    protected override async Task OnInitializedAsync()
    {
        MenuItems = new List<QND.Core.Models.MenuItem>
        {
            new() { Id = 1, Name = "Bia Hơi", Price = 150000, Description = "Bia mát lạnh.", ImageUrl="ca-bia-hoi.jfif" },
            new() { Id = 2, Name = "Đậu Tẩm Hành", Price = 250000, Description = "Món nhậu truyền thống.", ImageUrl="dau-tam-hanh.jfif" },
            new() { Id = 3, Name = "Rau Cải Xào Tỏi", Price = 20000, Description = "Rau tươi giòn ngon.", ImageUrl="rau-cai-xao.jfif" }
        };
    }

    private void OnAddToCart((QND.Core.Models.MenuItem Item, int Quantity) data)
    {
        CartItems.Add(data);
    }

    private void Checkout()
    {
        NavManager.NavigateTo($"/order/{TableCode}");
    }

    private void PayNow()
    {
        // Bạn có thể thêm logic gọi API gọi nhân viên tại đây
        Console.WriteLine($"Gọi nhân viên thanh toán: {TotalAmount}");
    }
}
